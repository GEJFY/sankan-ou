"""DBシードスクリプト - コース/トピック/デモユーザー/サンプルカード投入"""

import asyncio
import json
import uuid
from datetime import datetime, timezone
from pathlib import Path

from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession

from src.database import async_session_factory
from src.models import Card, CardReview, Course, Topic, User, UserEnrollment

SYLLABUS_DIR = Path(__file__).parent / "syllabus"

# デモユーザー (MVP用)
DEMO_USER_ID = uuid.UUID("00000000-0000-0000-0000-000000000001")

# サンプルカード (各トピック2-3枚のハードコード版、LLM生成は別途)
SAMPLE_CARDS = {
    "CIA": {
        "A. 内部監査の目的と権限": [
            {
                "front": "IIAの内部監査の定義において、内部監査の目的は何か？",
                "back": "組織体の運営に価値を付加し改善するために、独立にして客観的なアシュアランスおよびコンサルティング活動を提供すること。リスク・マネジメント、コントロールおよびガバナンスの各プロセスの有効性の評価・改善を通じて、組織体の目標達成に貢献する。",
            },
            {
                "front": "内部監査の「独立性」と「客観性」の違いを説明せよ。",
                "back": "独立性: 組織上の位置づけ（CAEが経営者から独立した報告ライン。取締役会への機能的報告）。\n客観性: 個人の心的態度。偏りなく公正に判断できる精神的態度。利益相反の回避が重要。",
            },
        ],
        "B. 倫理と職業専門性": [
            {
                "front": "IIA倫理綱要の4つの原則は何か？",
                "back": "1. 誠実性（Integrity）\n2. 客観性（Objectivity）\n3. 秘密の保持（Confidentiality）\n4. 専門的能力（Competency）",
            },
        ],
        "C. ガバナンスとリスクマネジメント": [
            {
                "front": "COSO ERMフレームワークの5つの構成要素は何か？",
                "back": "1. ガバナンスと文化\n2. 戦略と目標設定\n3. パフォーマンス\n4. レビューと修正\n5. 情報・伝達・報告",
            },
        ],
        "D. 不正リスク": [
            {
                "front": "不正のトライアングル（Fraud Triangle）の3要素は何か？",
                "back": "1. 動機・プレッシャー（Incentive/Pressure）\n2. 機会（Opportunity）\n3. 正当化（Rationalization）\nドナルド・R・クレッシーが提唱した理論。",
            },
        ],
        # Part 2: 内部監査の実務
        "A. 監査計画": [
            {
                "front": "リスクベース監査計画（Risk-Based Audit Plan）の策定プロセスを説明せよ。",
                "back": "1. 監査ユニバース（全監査対象）の特定\n2. リスクアセスメント（固有リスク・統制リスクを評価）\n3. リスクスコアリングによる優先順位付け\n4. 監査リソース（工数・人員）の配分\n5. CAEが取締役会・監査委員会へ計画を提示・承認取得\n6. 年間監査計画（Annual Audit Plan）の確定\n\n考慮事項: 規制要件、経営層の懸念、過去の監査結果、重大な変更（M&A等）",
            },
            {
                "front": "監査業務の予備調査（Preliminary Survey）の目的と実施内容を説明せよ。",
                "back": "目的: 監査対象について十分な理解を得て、重点監査領域を特定する。\n\n実施内容:\n1. 関連文書の収集（組織図・業務フロー・過去の監査報告書・内規）\n2. 経営者・担当者へのインタビュー\n3. 現場視察（ウォークスルー）\n4. 分析的手続（比率分析・トレンド分析）\n5. 予備的リスク評価\n\n成果物: 監査業務計画書（Engagement Plan）・RCM（リスクとコントロールのマトリクス）",
            },
            {
                "front": "監査サンプリングにおける統計的サンプリングと非統計的サンプリングの違いを説明せよ。",
                "back": "統計的サンプリング: 確率論に基づきサンプルサイズを決定。結果を母集団に客観的に推定可能。\n・属性サンプリング: 逸脱率の推定（統制テスト向き）\n・変数サンプリング: 金額の推定（実証手続向き）\n\n非統計的サンプリング: 監査人の判断でサンプル選定。結果の統計的推定は不可。\n\n選択基準: 母集団の性質、要求される信頼水準、コスト制約。IIA基準ではどちらも容認。",
            },
        ],
        "B. 監査業務の実施": [
            {
                "front": "監査証拠の十分性（Sufficiency）と適切性（Appropriateness）の違いを説明せよ。",
                "back": "十分性（Sufficiency）: 監査証拠の量的な概念。\n・監査結論を支持するのに必要な証拠量が確保されているか\n・リスクレベルが高いほど多くの証拠が必要\n\n適切性（Appropriateness）: 監査証拠の質的な概念。\n・関連性（Relevance）: 監査目標に関連しているか\n・信頼性（Reliability）: 証拠の出所と性質（外部文書＞内部文書、原本＞コピー）\n\n両者を合わせて「十分かつ適切な（Sufficient and Appropriate）」証拠が必要。",
            },
            {
                "front": "ウォークスルー（Walkthrough）の目的と実施手順を説明せよ。",
                "back": "目的: 業務プロセスとコントロールの実際の運用状況を、取引の始まりから終わりまで追跡し理解する。\n\n手順:\n1. 対象プロセスで発生した実際の取引を1件選定\n2. その取引が処理される各ステップを原始書類から完了記録まで追跡\n3. 各ステップで担当者にインタビュー・文書確認\n4. コントロールが設計通り運用されているかを確認\n\n効果: 業務フロー図の正確性確認、コントロールのデザイン評価、重要なコントロールの識別",
            },
            {
                "front": "CAATs（コンピュータ利用監査技法）の主な種類と活用場面を説明せよ。",
                "back": "主な種類:\n1. 汎用監査ソフトウェア（GAS）: ACL/IDEA等。大量データの抽出・分析・異常検出\n2. テストデータ法: 既知のテストデータをシステムに投入し処理結果を検証\n3. 統合テスト法（ITF）: 本番環境内にダミー部門を設置しリアルタイムで検証\n4. 並行シミュレーション: 監査人独自のプログラムで本番データを再処理し結果を比較\n\n活用場面: 大量取引の網羅的分析、継続的監査（Continuous Auditing）、不正検出（ベンフォードの法則等）。",
            },
        ],
        "C. 監査結果と改善": [
            {
                "front": "監査報告書に含めるべき「監査所見（Audit Finding）」の5要素を説明せよ。",
                "back": "5C要素（PAISA）:\n1. Condition（状態）: 実際に発見した事実\n2. Criteria（基準）: あるべき姿・基準・要件\n3. Cause（原因）: 基準から逸脱した理由\n4. Effect（影響）: 組織への実際/潜在的影響\n5. Recommendation（勧告）: 改善のための具体的提案\n\n重要: 状態と基準のギャップが「所見」であり、影響の重大性が報告の優先度を決定する。",
            },
            {
                "front": "CAEによるフォローアップ（Follow-Up）監査の目的と手順を説明せよ。",
                "back": "目的: 経営者が監査所見に対して適時かつ適切な是正措置を講じたかを確認する。\n\n手順:\n1. 改善計画（Action Plan）の入手・記録\n2. 約定期日での是正措置完了確認\n3. 改善の有効性を証拠で検証\n4. 未対応事項をCAEが経営者・取締役会へ報告\n\nIIA基準2500: CAEはフォローアップを確保するプロセスを確立しなければならない。\n重大なリスクのある未是正事項は上位管理層・取締役会へエスカレーション。",
            },
            {
                "front": "内部監査の品質評価（QAIP: Quality Assurance and Improvement Program）の構成を説明せよ。",
                "back": "IIA基準1300に基づく2つの評価:\n\n1. 内部評価:\n・継続的モニタリング（日常的な監督・チェックリスト）\n・定期的自己評価（年次セルフアセスメント）\n\n2. 外部評価:\n・5年に1回以上の外部品質評価（External Assessment）\n・独立した適格な評価者/チームが実施\n・「IIA基準に適合」等の意見を表明\n\nCAEは結果を取締役会に報告し、改善計画を策定する義務がある。",
            },
        ],
        # Part 3: ビジネス知識
        "A. 一般的なビジネスプロセス": [
            {
                "front": "COSO内部統制フレームワーク（2013年版）の5構成要素と17の原則の関係を説明せよ。",
                "back": "5構成要素:\n1. 統制環境（Control Environment）: 5原則\n   例: 誠実性・倫理的価値観、取締役会の監督\n2. リスク評価（Risk Assessment）: 4原則\n   例: 不正リスクの考慮、変化の識別と分析\n3. 統制活動（Control Activities）: 3原則\n   例: 統制活動の選択と展開、ITへの統制活動\n4. 情報と伝達（Information & Communication）: 3原則\n   例: 内部伝達、外部伝達\n5. モニタリング活動（Monitoring Activities）: 2原則\n   例: 継続的評価・独立的評価、欠陥の評価と伝達\n\n合計17原則が満たされて初めて有効な内部統制と判定される。",
            },
            {
                "front": "サプライチェーン・マネジメント（SCM）における内部監査の重点領域を説明せよ。",
                "back": "重点領域:\n1. 調達プロセス: 競争入札の実施、承認権限の遵守、ベンダー選定の透明性\n2. 在庫管理: 実地棚卸と帳簿の整合性、陳腐化リスク評価\n3. 物流・配送: 納期遵守率、輸送コスト最適化\n4. 支払プロセス: 三点照合（PO・検収・請求書）、架空仕入の防止\n5. サプライヤーリスク: 集中リスク、BCPの評価\n\n監査手続: データ分析で異常取引（分割発注・承認回避）を検出。",
            },
        ],
        "B. 情報テクノロジー": [
            {
                "front": "IT一般統制（ITGC: IT General Controls）の4カテゴリを説明せよ。",
                "back": "1. アクセス管理（Access to Programs and Data）\n   ・論理アクセス制御、特権ID管理、職務分掌\n\n2. プログラム変更管理（Program Change Controls）\n   ・変更要求→テスト→承認→本番移行の管理\n\n3. システム開発（System Development）\n   ・SDLC手法、ユーザー受入テスト（UAT）\n\n4. コンピュータ運用（Computer Operations）\n   ・バッチ処理監視、バックアップ・リカバリ、BCP\n\nITGCが有効でないとアプリケーション統制（自動化コントロール）の信頼性も低下する。",
            },
            {
                "front": "クラウドコンピューティング環境における内部監査の重点リスクを説明せよ。",
                "back": "重点リスク:\n1. データ所在地: 法域をまたぐデータ保管（GDPR・個人情報保護法への影響）\n2. アクセス管理: 共有責任モデル（IaaS/PaaS/SaaSで責任範囲が異なる）\n3. 可用性: SLA遵守状況、マルチAZ・マルチリージョン設計の検証\n4. データ漏洩: 暗号化（保存時・転送時）、鍵管理の適切性\n5. ベンダーロックイン: 移行戦略の存在確認\n\n監査手法: SOC 2報告書のレビュー、CSA STAR認証の確認。",
            },
        ],
        "C. 財務管理": [
            {
                "front": "内部監査人が財務分析で使用する主要財務比率を4カテゴリに分類して説明せよ。",
                "back": "1. 流動性比率（Liquidity）\n   ・流動比率 = 流動資産 ÷ 流動負債（目安: 2以上）\n   ・当座比率 = (流動資産－棚卸資産) ÷ 流動負債（目安: 1以上）\n\n2. 収益性比率（Profitability）\n   ・ROA = 純利益 ÷ 総資産\n   ・ROE = 純利益 ÷ 自己資本\n   ・売上高純利益率 = 純利益 ÷ 売上高\n\n3. レバレッジ比率（Leverage）\n   ・負債比率 = 総負債 ÷ 総資産\n   ・インタレスト・カバレッジ = EBIT ÷ 支払利息\n\n4. 効率性比率（Efficiency/Activity）\n   ・棚卸資産回転日数 = 365 ÷ (売上原価 ÷ 平均棚卸資産)\n   ・売上債権回転日数 = 365 ÷ (売上高 ÷ 平均売上債権)",
            },
            {
                "front": "資本予算（Capital Budgeting）の主要な評価手法を比較せよ。",
                "back": "1. NPV（正味現在価値）: 将来CFの現在価値合計 - 初期投資。NPV>0なら投資価値あり。最も理論的。\n2. IRR（内部収益率）: NPV=0となる割引率。資本コスト超なら採用。複数IRR問題に注意。\n3. 回収期間法: 初期投資回収までの期間。単純だが貨幣の時間価値を無視。\n4. PI（収益性指数）: 将来CFのPV ÷ 初期投資。PI>1なら採用。資本制約下のランキングに有用。\n\n内部監査: 投資案件の事前承認プロセスと事後評価（PIR）を検証。",
            },
        ],
        "D. 組織行動": [
            {
                "front": "マズローの欲求階層説（Maslow's Hierarchy of Needs）と内部監査への適用を説明せよ。",
                "back": "5段階の欲求（低次から高次）:\n1. 生理的欲求（Physiological）: 食・住・給与\n2. 安全欲求（Safety）: 雇用安定・労働環境\n3. 社会的欲求（Social/Belongingness）: 帰属感・良好な職場関係\n4. 承認欲求（Esteem）: 認知・昇進・責任ある業務\n5. 自己実現欲求（Self-Actualization）: 成長・挑戦的業務\n\n内部監査への適用:\n・低次欲求が未充足だと不正の動機（Fraud Triangle）につながる\n・監査人自身のモチベーション管理（継続的研鑽・CPE）\n・インタビュー時の被監査者の動機理解に活用",
            },
            {
                "front": "組織変革管理（Change Management）におけるコッターの8段階プロセスを説明せよ。",
                "back": "コッター（Kotter）の8段階:\n1. 危機意識を高める\n2. 変革推進チームを結成する\n3. ビジョンと戦略を策定する\n4. ビジョンを周知徹底する\n5. 従業員の自発的行動を促す\n6. 短期的成果を生み出す\n7. 成果を活かしてさらなる変革を推進する\n8. 新しいアプローチを企業文化に定着させる\n\n内部監査の視点: 変革プロジェクトの進捗評価、ステークホルダーの抵抗管理の有効性を評価。",
            },
        ],
    },
    "CISA": {
        "D1. 情報システム監査プロセス": [
            {
                "front": "IS監査計画で考慮すべきリスクベースアプローチとは何か？",
                "back": "限られた監査資源を最もリスクの高い領域に配分する手法。ビジネスリスク、IT環境の複雑さ、過去の監査結果、規制要件、経営層の懸念事項等を考慮してリスク評価を行い、監査対象と優先度を決定する。",
            },
            {
                "front": "IS監査における「証拠の十分性（Sufficiency）」と「適切性（Appropriateness）」の違いを説明し、IS監査特有の留意点を述べよ。",
                "back": "十分性（Sufficiency）: 監査結論を支持するために必要な証拠の量的側面。リスクレベルが高いほど多くの証拠が必要。\n適切性（Appropriateness）: 証拠の質的側面。以下2要素で構成される。\n・関連性（Relevance）: 証拠が監査目標に関連しているか\n・信頼性（Reliability）: 証拠の出所と性質（外部文書 > 内部文書、原本 > コピー）\n\nIS監査特有の留意点:\n・システム生成レポートやログは、コンピュータ処理の信頼性を先に確認しないと高い信頼性を認められない\n・CAATsを用いて収集した電子証拠は改ざんリスクへの対処（ハッシュ値検証等）が必要\n・両方を合わせた「十分かつ適切な（Sufficient and Appropriate）」証拠が監査結論の根拠となる",
            },
            {
                "front": "IS監査人の独立性と客観性を脅かす状況を3つ挙げ、対策を述べよ。",
                "back": "脅かす状況:\n1. 自己レビューの脅威: 以前自分が構築・導入したシステムを監査する場合\n2. 社会的圧力: 被監査部門の経営者が監査人の上司である場合\n3. 認知バイアス: 過去の監査結果に引きずられ先入観を持つ場合\n\n対策:\n・監査人のローテーション（同一領域の連続担当を制限）\n・CAEの機能的報告先を監査委員会に設定\n・監査前の独立性宣誓書の提出\n・ISACA倫理規程の遵守と年次研修の実施",
            },
        ],
        "D2. ITのガバナンスとマネジメント": [
            {
                "front": "COBIT 2019の設計要因（Design Factor）を3つ挙げよ。",
                "back": "1. 企業戦略\n2. 企業規模\n3. IT関連リスクプロファイル\n他に: 脅威ランドスケープ、コンプライアンス要件、IT部門の役割、調達モデル等がある。",
            },
            {
                "front": "ITバランスト・スコアカード（IT BSC）の4つの視点と、各視点の代表的な指標を説明せよ。また、COBIT 2019との関連性を述べよ。",
                "back": "1. 企業への貢献（Corporate Contribution）: ITが株主・経営への価値を提供しているか\n   指標例: IT投資ROI、ITコスト対売上高比率\n\n2. ユーザー志向（User Orientation）: ユーザー・顧客の満足度\n   指標例: ユーザー満足度スコア、SLA達成率、インシデント解決時間\n\n3. 業務卓越性（Operational Excellence）: ITプロセスの効率・品質\n   指標例: システム稼働率、変更成功率、セキュリティインシデント件数\n\n4. 将来志向（Future Orientation）: 将来の価値創造に向けた能力・革新\n   指標例: IT人材研修時間、新技術採用プロジェクト数、特許・イノベーション指標\n\nCOBIT 2019との関連: COBITのパフォーマンス目標（Goals）設計はIT BSCの視点を参照している。ITガバナンス目標の達成度測定にIT BSCメトリクスが活用される。",
            },
            {
                "front": "IT戦略委員会（IT Strategy Committee）とIT運営委員会（IT Steering Committee）の違いを説明せよ。",
                "back": "IT戦略委員会:\n・取締役会レベルで設置\n・IT投資の方向性・優先順位を決定\n・ITがビジネス戦略と整合しているかを監督\n・メンバー: 取締役、CEO、CIO\n\nIT運営委員会:\n・経営管理レベルで設置\n・IT戦略委員会の方針を具体的プロジェクトに落とし込む\n・プロジェクトの進捗管理・リソース配分を実行\n・メンバー: CIO、事業部門長、IT部門マネージャー\n\nIS監査人は両委員会の議事録・意思決定記録をレビューする。",
            },
        ],
        "D3. IS取得・開発・実装": [
            {
                "front": "システム開発ライフサイクル（SDLC）においてIS監査人が実施するポスト・インプリメンテーション・レビュー（PIR）の目的と主な確認事項を述べよ。",
                "back": "目的: 新システムが当初承認された要件・費用対効果目標・セキュリティ要件を達成しているかを事後評価し、将来のプロジェクト改善に活かす。\n\n主な確認事項:\n1. ビジネスケースの達成度 — 想定したROIと実際の費用対効果の比較\n2. 機能要件の充足度 — 承認された要件に対する実装カバー率\n3. セキュリティコントロールの実装状況 — 設計段階で定義したコントロールの実装確認\n4. UAT（ユーザー受入テスト）の結果と残存バグの管理状況\n5. 移行データの完全性・正確性（データ移行品質）\n6. 運用・保守体制の整備状況（SLA、障害対応手順）\n\n監査人はPIRに関与しながらも独立性を保ち、プロジェクトチームの自己評価に依存してはならない。",
            },
            {
                "front": "ITシステムの変更管理プロセス（Change Management）においてIS監査人が評価すべき主要なコントロールを5つ挙げ、各コントロールの目的を説明せよ。",
                "back": "1. 変更要求の正式な記録と権限者承認\n   目的: 未承認変更の防止。承認証跡（Audit Trail）の確保。\n\n2. 影響分析（Impact Assessment）の実施\n   目的: 変更が既存機能・依存システム・セキュリティに与える影響を事前評価し、意図しない障害を防ぐ。\n\n3. テスト環境の本番環境からの分離\n   目的: 未テストコードの本番流入を防ぐ。開発者が本番へ直接アクセスする職務分掌違反を防止。\n\n4. 緊急変更（Emergency Change）の統制\n   目的: 緊急対応時も証跡を残し、事後的な承認・レビューを義務付けることで統制のバイパスを防ぐ。\n\n5. バックアウト計画（Rollback Plan）の策定と演練\n   目的: 変更失敗時に迅速に元の状態へ復旧できる手順を確保し、可用性への影響を最小化する。\n\n追加評価: 変更承認委員会（CAB）の機能、変更ログの改ざん不可性、変更頻度の異常値分析。",
            },
            {
                "front": "アジャイル開発環境におけるIS監査の留意点を説明せよ。",
                "back": "留意点:\n1. 短いスプリントサイクルでの変更管理統制の維持\n2. ユーザーストーリーの受入基準がセキュリティ要件を含むか確認\n3. 継続的インテグレーション/デリバリー（CI/CD）パイプラインの統制\n4. DevSecOps: セキュリティテストの自動化（SAST/DAST）組込み確認\n5. スプリントレトロスペクティブの記録保持\n\n従来型監査との違い: ウォーターフォールのフェーズゲートに代わり、スプリント毎のバックログ・バーンダウンチャートをレビュー。",
            },
        ],
        "D4. IS運用とビジネスレジリエンス": [
            {
                "front": "事業継続計画（BCP）策定における業務影響分析（BIA）で算出するRTO・RPO・MTDを定義し、相互の制約関係を図示的に説明せよ。",
                "back": "定義:\n・RTO（Recovery Time Objective）: 障害発生からシステムを復旧するまでの目標時間\n・RPO（Recovery Point Objective）: 許容できるデータ損失の最大範囲（どの時点まで遡るか）\n・MTD（Maximum Tolerable Downtime）: 業務が停止できる最大許容時間。超過すると組織の存続に影響\n\n制約関係:\n  障害発生 ─── RTO ───→ 復旧完了\n  └── MTD は RTO の上限: RTO ≦ MTD（必須条件）\n  └── RTO > MTD なら計画失敗\n\nRPOの設計影響:\n・RPO = 1時間 → バックアップを1時間ごとに取得\n・RPO = 0（ゼロ） → リアルタイムレプリケーションが必要\n\nIS監査人の確認事項: BIA文書の経営層承認、RTOに対応した復旧手順の文書化、定期的なDR訓練と結果記録、訓練結果とRTO目標の差異分析。",
            },
            {
                "front": "IS監査におけるキャパシティ管理（Capacity Management）の監査手続きを説明し、クラウド環境特有の追加評価ポイントを述べよ。",
                "back": "オンプレミス環境での監査手続き:\n1. キャパシティ計画書の存在・最新性・経営層承認の確認\n2. CPU・メモリ・ストレージ・ネットワーク帯域の利用率トレンド分析（過去12ヶ月）\n3. 閾値アラートの設定値（例: CPU 80%で警告）と通知・エスカレーションプロセスの有効性確認\n4. ストレステスト・ピーク負荷テストの実施記録と結果のレビュー\n5. 将来需要予測（ビジネス成長計画との整合性）の合理性評価\n\nクラウド環境の追加評価ポイント:\n・オートスケーリング設定の妥当性（スケールイン/アウト条件、最大インスタンス数の上限）\n・コスト管理との整合性（無制限スケールによるコスト爆発リスク）\n・クラウドプロバイダーのSLA（例: 99.99%可用性）と自組織のRTOの整合性確認\n・マルチリージョン・マルチAZ構成によるレジリエンス設計の検証\n\n典型的な発見事項: キャパシティ計画未策定、閾値設定が過度に高い（95%超で初警告）、過去トレンドに基づく将来予測がない。",
            },
            {
                "front": "ITサービスマネジメント（ITSM）におけるインシデント管理と問題管理の違いを説明せよ。",
                "back": "インシデント管理:\n・目的: サービスの迅速な復旧（応急処置）\n・焦点: 影響の最小化とSLA内での解決\n・例: サーバーダウン→フェイルオーバー切替で復旧\n\n問題管理:\n・目的: インシデントの根本原因の特定と恒久的解決\n・焦点: 再発防止（RCA: Root Cause Analysis）\n・例: サーバーダウンの原因がメモリリーク→コード修正\n\nIS監査の確認事項: インシデント記録の網羅性、エスカレーション手順の遵守、既知エラーDB（KEDB）の維持、SLA達成率の測定。ITIL v4フレームワーク準拠が一般的。",
            },
        ],
        "D5. 情報資産の保護": [
            {
                "front": "多層防御（Defense in Depth）の概念を説明せよ。",
                "back": "複数のセキュリティ層を配置し、一つの防御が突破されても他の層で攻撃を食い止める戦略。物理的セキュリティ→ネットワーク→ホスト→アプリケーション→データの各層で対策を講じる。",
            },
            {
                "front": "データ分類（Data Classification）とアクセス制御の関係を説明し、IS監査人が確認すべき具体的な手続きを述べよ。",
                "back": "データ分類の目的: 情報資産を機密性・重要性に基づいてカテゴリ化（例: 極秘→機密→社内限→公開）し、各カテゴリのハンドリング要件・保護策・廃棄基準を定義する。\n\nアクセス制御との関係:\n・分類レベルが高いデータほどNeed-to-Know原則と最小権限原則に基づく厳格なアクセス制御が必要\n・データオーナー（Data Owner）が分類を決定し、ITがそれに基づくアクセス権を実装する役割分担が重要\n\nIS監査人の確認手続き:\n1. データ分類ポリシーの存在・経営層承認・全員への周知状況\n2. 全データ資産に対するData Ownerの割当状況（空白領域の有無）\n3. 分類ラベルに対応したアクセス権設定の論理アクセスレビュー（分類と権限の整合性）\n4. 機密データの暗号化（保存時・転送時）・マスキング実装状況\n5. データ保持・廃棄ポリシーの遵守状況（不要データの適切な消去証跡）\n6. 分類ポリシーに関する定期教育の実施記録",
            },
            {
                "front": "ペネトレーションテスト（侵入テスト）のブラックボックス・グレーボックス・ホワイトボックスの3種類を比較し、IS監査人がテスト結果をレビューする際の評価ポイントを説明せよ。",
                "back": "3種類の比較:\nブラックボックス: 内部情報なし。外部攻撃者の視点を最も忠実に再現。時間・費用が大きく、発見網羅性は限定的。\nグレーボックス: 部分的な内部情報（ネットワーク図・一般ユーザー権限等）を付与。効率とリアリティのバランスが良い。CISA試験では最も一般的として頻出。\nホワイトボックス: ソースコード・設計書等を全開示。網羅的な脆弱性発見に有効。開発工程での利用に適す。\n\nIS監査人のレビュー評価ポイント:\n1. スコープ定義の妥当性 — 重要システムが対象外になっていないか\n2. テスト実施者の独立性・資格 — OSCP等の資格保有、発注者との利益相反がないか\n3. 発見事項の深刻度分類（Critical/High/Medium/Low）の根拠\n4. 是正措置の実施状況と追跡 — 高深刻度の脆弱性が放置されていないか\n5. 再テスト（Retest）の実施確認 — 是正後の効果検証\n6. 経営層・取締役会への報告状況と年次実施計画の存在",
            },
            {
                "front": "ゼロトラストアーキテクチャ（Zero Trust Architecture）の原則とIS監査での評価ポイントを説明せよ。",
                "back": "基本原則: 「決して信頼せず、常に検証する（Never Trust, Always Verify）」\n\n主要要素:\n1. マイクロセグメンテーション: ネットワークを細分化し横方向移動を制限\n2. 最小権限アクセス: ユーザー・デバイス毎にリソース単位で認可\n3. 継続的認証: セッション中もリスクスコアに基づき再認証\n4. デバイス信頼性: エンドポイントの健全性を検証（MDM/EDR連携）\n\nIS監査の評価ポイント:\n・ID管理基盤（IdP）の統合度とMFA導入率\n・ネットワークセグメンテーションの実装状況\n・ログ収集・分析（SIEM）によるリアルタイム監視体制",
            },
        ],
    },
    "CFE": {
        "S1. 財務取引と不正スキーム": [
            {
                "front": "横領（Embezzlement）とラーセニー（Larceny）の違いは？",
                "back": "横領: 正当に預かった他人の財産を不正に自己のものにする行為。受託関係の濫用。\nラーセニー: 他人の財産を同意なく不法に取得する行為。最初から占有権がない。\n横領は信頼関係の裏切りである点で罪が重いとされる。",
            },
            {
                "front": "財務諸表不正（Financial Statement Fraud）の主な手法を5つ挙げよ。",
                "back": "1. 収益の過大計上: 架空売上の計上、カットオフ操作（期間帰属の操作）\n2. 費用の過少計上: 費用の資産計上（資本化）、引当金の不足計上\n3. 資産の過大評価: 棚卸資産の水増し、減損の不認識\n4. 負債の過少開示: 簿外債務（偶発債務の未開示）\n5. 不適切な開示: 関連当事者取引の隠蔽、重要事象の未注記\n\nACFE調査: 財務諸表不正は発生件数は少ないが、1件あたりの損害額は最大（中央値$954K）。",
            },
        ],
        "S2. 法律（Law）": [
            {
                "front": "米国SOX法（Sarbanes-Oxley Act）のSection 302とSection 404の違いは？",
                "back": "Section 302: CEOとCFOが財務報告の正確性を個人的に証明する義務。\nSection 404: 内部統制の有効性について経営者評価と外部監査人による検証を要求。\nどちらもエンロン事件等を受けて2002年に制定。",
            },
            {
                "front": "民事訴訟と刑事訴訟における立証責任（Burden of Proof）の違いを不正調査の文脈で説明せよ。",
                "back": "刑事訴訟:\n・立証責任: 検察側\n・証明基準: 合理的な疑いを超える証明（Beyond a Reasonable Doubt）\n・結果: 有罪→禁固・罰金等の刑罰\n\n民事訴訟:\n・立証責任: 原告側\n・証明基準: 証拠の優越（Preponderance of Evidence）— 50%超の蓋然性\n・結果: 損害賠償・差止命令等\n\n不正調査への影響: 刑事の証明基準が高いため、CFEは民事・刑事両方の基準を想定して証拠を収集・保全すべき。",
            },
        ],
        "S3. 調査（Investigation）": [
            {
                "front": "不正調査におけるインタビューの種類と実施順序を説明せよ。",
                "back": "実施順序（外側から内側へ）:\n1. 中立的な第三者: 背景情報の収集\n2. 協力的な証人: 事実関係の確認\n3. 共犯の可能性がある者: 矛盾の確認\n4. 対象者（被疑者）: 最後に実施\n\n被疑者インタビューの3段階:\n・導入部: ラポール構築、非対立的な質問\n・情報収集部: オープン質問→クローズド質問\n・自白勧奨部（Admission-Seeking）: 合理化の機会を提供\n\n注意: 脅迫・強要は証拠能力を失わせる。弁護士同席の権利に留意。",
            },
            {
                "front": "デジタルフォレンジック調査で証拠保全の連鎖（Chain of Custody）が重要な理由と維持方法を説明せよ。",
                "back": "重要な理由:\n・証拠の完全性・信頼性を法廷で立証するため\n・証拠の改ざん・汚染がないことを証明するため\n・Chain of Custodyが途切れると証拠能力が否定される\n\n維持方法:\n1. 証拠取得時にハッシュ値（SHA-256等）を算出・記録\n2. 証拠取扱い記録: 誰が・いつ・何を・なぜアクセスしたか\n3. 原本の保全: 作業はコピー（フォレンジックイメージ）に対して実施\n4. 物理的な施錠保管と限定的なアクセス権限\n5. 全ての移転・引渡しで受領書を取得",
            },
        ],
        "S4. 不正防止と抑止": [
            {
                "front": "不正通報制度（Whistleblower Program）が効果的であるための要件を3つ挙げよ。",
                "back": "1. 匿名性の保証（通報者の身元保護）\n2. 報復からの保護（法的・組織的保護策）\n3. 独立した受付窓口（外部委託のホットライン等）\n追加: 経営層のコミットメント、通報後のフォローアップ、定期的な教育・啓発。",
            },
            {
                "front": "不正リスクアセスメント（Fraud Risk Assessment）の実施手順を説明せよ。",
                "back": "手順:\n1. 不正リスクの識別: ブレインストーミング、過去の不正事例分析、業界ベンチマーク\n2. 発生可能性と影響度の評価: リスクマトリクスで分類（高/中/低）\n3. 既存統制の評価: 識別されたリスクに対する予防的・発見的統制の有効性\n4. 残余リスクの判定: 統制後も残るリスクレベルの評価\n5. 対応策の策定: 追加統制の導入、モニタリングの強化\n\nACFE推奨: 年次で実施し取締役会に報告。Fraud Triangle（動機・機会・正当化）の各要素を考慮。",
            },
        ],
    },
    "USCPA": {
        "AUD-A. 監査の倫理・独立性・品質管理": [
            {
                "front": "AICPA倫理規程における独立性の2つの側面を説明せよ。",
                "back": "1. Independence in fact（精神的独立性）: 監査人が実際に偏りなく判断できる精神状態\n2. Independence in appearance（外観的独立性）: 合理的な第三者から見て独立と認識される状態\n両方を満たす必要がある。",
            },
        ],
        "AUD-B. 監査業務の計画と実施": [
            {
                "front": "監査リスクモデル（Audit Risk Model）の公式と各要素を説明せよ。",
                "back": "AR = IR × CR × DR\nAR（Audit Risk）: 監査リスク\nIR（Inherent Risk）: 固有リスク\nCR（Control Risk）: 統制リスク\nDR（Detection Risk）: 発見リスク\n監査人はDRを調整して許容AR水準を達成する。",
            },
        ],
        "FAR-A. 財務会計の基礎": [
            {
                "front": "ASC 606（収益認識基準）の5ステップモデルを説明せよ。",
                "back": "1. 契約の識別\n2. 履行義務の識別\n3. 取引価格の算定\n4. 取引価格の履行義務への配分\n5. 履行義務充足時の収益認識\nIFRS 15とほぼ同一の基準。",
            },
        ],
        "AUD-C. 内部統制の評価": [
            {
                "front": "統合監査（Integrated Audit）において内部統制の重要な欠陥（Material Weakness）と重大な不備（Significant Deficiency）の違いを説明せよ。",
                "back": "重要な欠陥（Material Weakness）:\n・内部統制の不備で、財務諸表の重要な虚偽表示が防止・発見されない合理的な可能性がある\n・監査意見に影響: 「内部統制は有効でない」と報告\n\n重大な不備（Significant Deficiency）:\n・MWほど深刻ではないが、監査委員会に報告すべき重要な不備\n・監査意見には影響しないが書面で伝達\n\n判断基準: 虚偽表示の発生可能性と金額的重要性の組合せ。",
            },
        ],
        "AUD-D. 監査報告書": [
            {
                "front": "監査意見の4種類とそれぞれの発行条件を説明せよ。",
                "back": "1. 無限定適正意見（Unqualified/Unmodified）: 財務諸表がGAAPに準拠して適正に表示\n2. 限定付適正意見（Qualified）: 特定の項目を除きGAAP準拠。重要だが広範でない虚偽表示\n3. 不適正意見（Adverse）: 重要かつ広範な虚偽表示。財務諸表全体が適正でない\n4. 意見不表明（Disclaimer）: 十分な監査証拠を入手できず判断不能\n\n判断軸: 虚偽表示/範囲制限の「重要性」と「広範性」の2軸マトリクス。",
            },
        ],
        "FAR-B. 資産の会計処理": [
            {
                "front": "ASC 842（リース会計基準）におけるオペレーティングリースとファイナンスリースの分類基準を説明せよ。",
                "back": "以下の5基準のいずれかを満たせばファイナンスリース:\n1. 所有権移転: リース期間終了時に所有権が借手に移転\n2. 割安購入選択権: 行使が合理的に確実\n3. リース期間: 原資産の経済的耐用年数の大部分（≒75%）\n4. 現在価値: リース料総額のPVが原資産のFVの実質的全部（≒90%）\n5. 特殊性: 原資産が借手に特化した仕様\n\nいずれも満たさない場合はオペレーティングリース。両タイプとも使用権資産とリース負債を計上（ASC 842の重要変更点）。",
            },
        ],
        "FAR-D. 政府会計・非営利会計": [
            {
                "front": "政府会計（Governmental Accounting）における基金会計（Fund Accounting）の3分類を説明せよ。",
                "back": "1. 政府活動型基金（Governmental Funds）:\n   ・一般基金、特別収入基金、資本事業基金、債務返済基金、恒久基金\n   ・修正発生主義（Modified Accrual Basis）を使用\n   ・現在の財務資源の測定に焦点\n\n2. 事業活動型基金（Proprietary Funds）:\n   ・企業基金、内部サービス基金\n   ・発生主義（Full Accrual Basis）を使用\n\n3. 受託基金（Fiduciary Funds）:\n   ・年金信託基金、投資信託基金、私的目的信託基金、受託者基金\n   ・発生主義を使用",
            },
        ],
        "REG-A. 個人所得税": [
            {
                "front": "米国所得税における Above-the-line deductions と Below-the-line deductions の違いは？",
                "back": "Above-the-line: AGI算出前に控除。例: IRA拠出金、学生ローン利息。全納税者が利用可。\nBelow-the-line: AGI算出後に控除。Standard deduction か Itemized deduction を選択。",
            },
        ],
        "REG-B. 法人税": [
            {
                "front": "米国法人税における S Corporation と C Corporation の主な違いを説明せよ。",
                "back": "C Corporation:\n・法人レベルで課税（二重課税: 法人税 + 配当時の個人所得税）\n・株主数制限なし、外国人株主可\n\nS Corporation:\n・パススルー課税（法人レベルでは非課税、株主の個人所得に合算）\n・制限: 株主100人以下、米国居住者のみ、1クラスの株式のみ\n・選択方法: Form 2553をIRSに提出\n\n選択基準: 事業規模、株主構成、二重課税の回避ニーズ。",
            },
        ],
        "REG-C. ビジネス法": [
            {
                "front": "契約法における有効な契約の4要件を説明せよ。",
                "back": "1. 申込みと承諾（Offer and Acceptance）: 明確な申込みとそれに対する無条件の承諾\n2. 約因（Consideration）: 双方が価値あるものを提供する相互交換\n3. 契約能力（Capacity）: 成人であること、精神的能力があること\n4. 合法性（Legality）: 契約目的が合法であること\n\n追加要素: 詐欺防止法（Statute of Frauds）により一定の契約は書面が必要（不動産売買、1年超の契約、$500超の物品売買等）。",
            },
        ],
        "BAR-A. 財務データ分析": [
            {
                "front": "データ分析における回帰分析（Regression Analysis）の監査での活用方法を説明せよ。",
                "back": "活用方法:\n1. 売上予測モデル: 過去データから売上の期待値を推定し、実績との乖離を異常値として検出\n2. 費用の合理性検証: 売上高と変動費の関係性を回帰分析で検証\n3. 引当金の妥当性: 貸倒実績率の予測モデル構築\n\n主要指標:\n・R²（決定係数）: モデルの説明力（0〜1、高いほど良好）\n・p値: 変数の統計的有意性（<0.05が一般的基準）\n・残差分析: 予測値と実績の差の分布確認\n\nCPA試験: TBS形式でExcelを用いた回帰分析の実務問題が出題。",
            },
        ],
        "BAR-C. 原価計算・管理会計": [
            {
                "front": "活動基準原価計算（Activity-Based Costing: ABC）と伝統的配賦法の違いを説明せよ。",
                "back": "伝統的配賦法:\n・製造間接費を単一または少数の配賦基準（直接労務時間等）で配賦\n・製品の多様性が少ない場合に適する\n\nABC:\n・活動（Activity）を識別し、コストドライバーに基づき間接費を配賦\n・手順: 活動識別→コストプール設定→コストドライバー選定→製品に配賦\n・利点: 製品原価の正確性向上、間接費比率が高い環境で有効\n・欠点: 導入コストが高い、活動・ドライバーの選定が主観的\n\nCPA試験: 伝統的配賦とABCの配賦結果の差異計算が頻出。",
            },
        ],
    },
    "BOKI1": {
        "BOKI-A. 特殊商品売買・収益認識": [
            {
                "front": "収益認識基準（企業会計基準第29号）の5ステップモデルを説明せよ。",
                "back": "1. 契約の識別: 顧客との契約を識別\n2. 履行義務の識別: 契約内の別個の財・サービスを識別\n3. 取引価格の算定: 変動対価・重大な金融要素等を考慮\n4. 取引価格の配分: 独立販売価格の比率で各履行義務に配分\n5. 履行義務の充足時に収益認識: 一時点 or 一定期間にわたり充足\n\n簿記1級での論点: 割賦販売、返品権付販売、ポイント付与取引の会計処理。",
            },
        ],
        "BOKI-B. 連結会計": [
            {
                "front": "連結修正仕訳で「投資と資本の相殺消去」の基本仕訳を示せ。",
                "back": "（借方）資本金 ×× / （貸方）子会社株式 ××\n（借方）利益剰余金 ××\n（借方）のれん ×× ← 差額\n（貸方）非支配株主持分 ×× ← 子会社純資産×非支配持分比率",
            },
        ],
        "BOKI-C. 企業結合・事業分離": [
            {
                "front": "企業結合における取得の会計処理（パーチェス法）の手順を説明せよ。",
                "back": "手順:\n1. 取得企業の識別: 支配を獲得した企業を特定\n2. 取得日の決定: 支配を獲得した日\n3. 取得原価の算定: 対価の公正価値\n4. 識別可能な資産・負債の認識: 被取得企業の資産・負債を取得日の公正価値で評価\n5. のれんの算定: 取得原価 - 識別可能純資産の公正価値 × 持分比率\n\n負ののれん: 取得原価 < 識別可能純資産のFV の場合、特別利益として一括認識。\n簿記1級: のれんは20年以内に均等償却（IFRS: 非償却+減損テスト）。",
            },
        ],
        "BOKI-D. 金融商品会計": [
            {
                "front": "金融商品の分類と測定方法（その他有価証券の会計処理）を説明せよ。",
                "back": "有価証券の4分類:\n1. 売買目的有価証券: 時価評価、評価差額は損益（P/L）\n2. 満期保有目的の債券: 取得原価（償却原価法）\n3. 子会社・関連会社株式: 取得原価（連結では持分法）\n4. その他有価証券: 時価評価、評価差額は純資産の部（全部/部分純資産直入法）\n\nその他有価証券の処理:\n・全部純資産直入法: 評価差額の全額をOCI（その他有価証券評価差額金）に計上\n・部分純資産直入法: 評価益はOCI、評価損は損益に計上\n・税効果適用: 繰延税金資産/負債を認識。",
            },
        ],
        "BOKI-E. 外貨換算・在外子会社": [
            {
                "front": "外貨建取引の換算基準と為替差損益の処理を説明せよ。",
                "back": "換算基準:\n・取引発生時: 取引日のレート（HR）で換算\n・決算時: 貨幣項目は決算日レート（CR）、非貨幣項目は取引日レート（HR）\n・決済時: 決済日レートで換算、差額を為替差損益に計上\n\n在外子会社の財務諸表換算（テンポラル法 vs 決算日レート法）:\n・決算日レート法（原則）: 資産・負債はCR、純資産はHR、P/LはAR（期中平均レート）\n・換算差額: 為替換算調整勘定（純資産の部）に計上\n\n簿記1級: 為替予約（振当処理 vs 独立処理）の仕訳が頻出。",
            },
        ],
        "ACCT-A. 財務諸表論": [
            {
                "front": "概念フレームワークにおける財務情報の質的特性を説明せよ。",
                "back": "基本的な質的特性:\n1. 目的適合性（Relevance）: 予測価値・確認価値を有する\n2. 忠実な表現（Faithful Representation）: 完全性・中立性・無誤謬性\n\n補強的な質的特性:\n1. 比較可能性: 企業間・期間比較が可能\n2. 検証可能性: 独立した観察者が同一結論に到達可能\n3. 適時性: 意思決定に間に合うタイミングで提供\n4. 理解可能性: 合理的な知識を有する利用者が理解可能\n\n制約条件: コストと便益のバランス（コスト制約）。重要性は目的適合性のエンティティ固有の側面。",
            },
        ],
        "ACCT-B. 税効果会計": [
            {
                "front": "繰延税金資産の回収可能性の判断基準を5つの分類で説明せよ。",
                "back": "分類1: 過去3年以上連続で課税所得がプラス → 全額回収可能\n分類2: 安定的に課税所得を計上 → スケジューリング可能な範囲\n分類3: 業績不安定 → 合理的な見積可能期間のみ\n分類4: 重要な税務上の欠損金 → 翌期の見積範囲のみ\n分類5: 過去3年以上連続で欠損金 → 原則回収不能",
            },
        ],
        "ACCT-C. 退職給付会計": [
            {
                "front": "退職給付会計における退職給付債務（PBO）の構成要素と数理計算上の差異の処理を説明せよ。",
                "back": "退職給付債務の構成:\n・勤務費用: 当期の労働に対応する退職給付の増加額\n・利息費用: 期首PBO × 割引率\n・数理計算上の差異: 見積りと実績の乖離、前提条件の変更\n・過去勤務費用: 制度の改訂に伴う給付水準の変動\n\n数理計算上の差異の処理:\n・原則: 発生した期の翌期から平均残存勤務期間にわたり費用処理（遅延認識）\n・回廊アプローチ: 期首のPBOまたは年金資産の大きい方の10%超の部分のみ費用処理\n\nB/S表示: 退職給付引当金 = PBO - 年金資産の公正価値 ± 未認識項目。",
            },
        ],
        "COST-A. 個別原価計算・総合原価計算": [
            {
                "front": "総合原価計算における完成品換算量（Equivalent Units）の計算方法を先入先出法と平均法で比較せよ。",
                "back": "平均法:\n・完成品換算量 = 完成品数量 + 期末仕掛品の換算量\n・当期投入分と期首仕掛品を区別しない\n・計算が簡便\n\n先入先出法:\n・完成品換算量 = 期首仕掛品の追加加工分 + 当期着手完成分 + 期末仕掛品の換算量\n・当期の製造実績のみを反映（より正確）\n\n例: 期首仕掛品200個(40%完成)、完成品800個、期末仕掛品100個(60%完成)\n・平均法: 800 + 100×60% = 860\n・先入先出法: 200×60% + 600 + 100×60% = 780",
            },
        ],
        "COST-B. 標準原価計算": [
            {
                "front": "標準原価計算の差異分析で、直接材料費差異の2区分を説明せよ。",
                "back": "価格差異 = (実際単価 - 標準単価) × 実際消費量\n数量差異 = (実際消費量 - 標準消費量) × 標準単価\n価格差異は購買部門、数量差異は製造部門の責任として管理。",
            },
        ],
        "MGMT-B. 意思決定会計": [
            {
                "front": "差額原価収益分析（Differential Cost Analysis）による業務意思決定の手法を説明せよ。",
                "back": "差額原価: 代替案間で異なる原価（意思決定に関連する原価）\n埋没原価: どの代替案でも変わらない原価（意思決定に無関係）\n機会原価: 選択しなかった代替案から得られたはずの最大利益\n\n適用場面:\n1. 自製 vs 購入: 差額原価 + 機会原価で比較\n2. 追加加工の可否: 分離点後の追加加工による増分収益 vs 増分原価\n3. 特別注文の受諾: 増分収益 > 増分原価（遊休能力の範囲内）\n4. セグメントの廃止: 回避可能固定費 vs 貢献利益\n\n注意: 埋没原価（取得原価等）に惑わされない判断が重要。",
            },
        ],
        "MGMT-A. CVP分析・損益分岐点": [
            {
                "front": "損益分岐点売上高の算出式を示せ。",
                "back": "損益分岐点売上高 = 固定費 ÷ 貢献利益率\n貢献利益率 = 1 - 変動費率\n損益分岐点数量 = 固定費 ÷ 単位あたり貢献利益\n安全余裕率 = (実際売上高 - BEP売上高) ÷ 実際売上高 × 100",
            },
        ],
    },
    "FP": {
        "FP-A. ライフプランニングと資金計画": [
            {
                "front": "6つの係数（年金終価係数、減債基金係数等）を用途別に整理せよ。",
                "back": "1. 終価係数: 現在の元本が将来いくらになるか\n2. 現価係数: 将来の金額の現在価値\n3. 年金終価係数: 毎年の積立が将来いくらになるか\n4. 減債基金係数: 将来の目標額に必要な毎年の積立額\n5. 年金現価係数: 毎年一定額受取るための必要元本\n6. 資本回収係数: 元本から毎年いくら受取れるか",
            },
            {
                "front": "公的年金制度の体系（国民年金・厚生年金・企業年金）と支給要件を説明せよ。",
                "back": "1階: 国民年金（基礎年金）\n・被保険者: 第1号(自営業等)、第2号(会社員・公務員)、第3号(第2号の被扶養配偶者)\n・受給資格: 10年以上の加入期間\n・老齢基礎年金: 満額 約81万円/年（2024年度）\n\n2階: 厚生年金\n・対象: 第2号被保険者（会社員・公務員）\n・報酬比例部分: 平均標準報酬額 × 給付乗率 × 加入月数\n\n3階: 企業年金\n・確定給付企業年金（DB）: 給付額が確定\n・確定拠出年金（DC）: 拠出額が確定、運用リスクは加入者\n・iDeCo: 個人型確定拠出年金、掛金は全額所得控除",
            },
        ],
        "FP-B. リスク管理": [
            {
                "front": "生命保険の主な種類と税務上の取扱いを説明せよ。",
                "back": "主な種類:\n1. 定期保険: 一定期間の死亡保障、掛捨て、保険料安い\n2. 終身保険: 一生涯の死亡保障、貯蓄性あり、解約返戻金あり\n3. 養老保険: 満期保険金あり、死亡保険金=満期保険金\n4. 個人年金保険: 老後の年金受取り\n\n税務上の取扱い:\n・保険料: 一般の生命保険料控除（最大4万円）、個人年金保険料控除（最大4万円）、介護医療保険料控除（最大4万円）\n・死亡保険金: 相続税（法定相続人×500万円の非課税枠）\n・満期保険金: 一時所得（一時所得 = 受取額 - 払込保険料 - 50万円、課税は1/2）\n・個人年金: 雑所得",
            },
            {
                "front": "損害保険の基本原則を4つ説明せよ。",
                "back": "1. 利得禁止の原則: 保険によって利益を得てはならない（実損填補）\n2. 被保険利益: 保険の目的に経済的利害関係があること（保険契約の前提条件）\n3. 告知義務: 契約時に重要事項を正確に申告する義務。違反すると契約解除\n4. 損害填補の原則: 実際の損害額を限度に保険金を支払う\n\n関連制度:\n・超過保険: 保険金額 > 保険価額 → 保険価額までしか支払われない\n・重複保険: 複数契約で合計が保険価額超 → 各社按分\n・比例填補: 一部保険の場合、保険金 = 損害額 × (保険金額/保険価額)",
            },
        ],
        "FP-C. 金融資産運用": [
            {
                "front": "ポートフォリオ理論における分散投資効果とシャープレシオを説明せよ。",
                "back": "分散投資効果:\n・異なる資産を組み合わせることで、ポートフォリオ全体のリスクを低減\n・相関係数が低いほど分散効果が大きい（相関係数: -1〜+1）\n・システマティックリスク（市場リスク）は分散不可能\n・アンシステマティックリスク（個別リスク）は分散で除去可能\n\nシャープレシオ:\n= (ポートフォリオ収益率 - 無リスク資産利子率) ÷ 標準偏差\n・リスク1単位あたりの超過収益を測定\n・値が大きいほど効率的な運用\n\n1級FP: 標準偏差の計算、相関係数を用いたポートフォリオのリスク算出が出題。",
            },
            {
                "front": "債券の利回り計算（最終利回り・応募者利回り・所有期間利回り）を説明せよ。",
                "back": "最終利回り（%）:\n= {表面利率 + (額面 - 買付価格) ÷ 残存年数} ÷ 買付価格 × 100\n\n応募者利回り（%）:\n= {表面利率 + (額面 - 発行価格) ÷ 償還年数} ÷ 発行価格 × 100\n\n所有期間利回り（%）:\n= {表面利率 + (売却価格 - 買付価格) ÷ 所有年数} ÷ 買付価格 × 100\n\n例: 額面100円、表面利率2%、買付価格97円、残存5年\n最終利回り = {2 + (100-97)÷5} ÷ 97 × 100 ≒ 2.68%\n\n債券価格と金利の関係: 金利上昇→債券価格下落（逆相関）。デュレーションが長いほど金利感応度が高い。",
            },
        ],
        "FP-D. タックスプランニング": [
            {
                "front": "所得税の10種類の所得を列挙せよ。",
                "back": "1. 利子所得 2. 配当所得 3. 不動産所得 4. 事業所得\n5. 給与所得 6. 退職所得 7. 山林所得 8. 譲渡所得\n9. 一時所得 10. 雑所得\n損益通算可能: 不動産・事業・山林・譲渡（ふじさんじょう）",
            },
        ],
        "FP-E. 不動産": [
            {
                "front": "不動産の価格評価方法3手法と公的価格4種類を説明せよ。",
                "back": "鑑定評価の3手法:\n1. 原価法: 再調達原価 - 減価修正。建物評価に適する\n2. 取引事例比較法: 類似物件の取引価格から比準。土地評価に適する\n3. 収益還元法: 将来収益の現在価値。投資物件に適する\n   ・直接還元法: 純収益 ÷ 還元利回り\n   ・DCF法: 将来CF割引合計 + 復帰価格の現在価値\n\n公的価格4種類:\n1. 公示価格（国土交通省）: 1/1時点、3月公表。取引の指標\n2. 基準地標準価格（都道府県）: 7/1時点、9月公表\n3. 相続税路線価（国税庁）: 公示価格の約80%。相続税・贈与税の算定\n4. 固定資産税評価額（市町村）: 公示価格の約70%。3年毎に評価替え",
            },
            {
                "front": "借地借家法における普通借家契約と定期借家契約の違いを説明せよ。",
                "back": "普通借家契約:\n・期間: 1年以上（1年未満は期間の定めのない契約とみなす）\n・更新: 正当事由がなければ貸主は更新拒絶不可\n・通知: 期間満了の1年〜6ヶ月前に通知\n\n定期借家契約:\n・期間: 制限なし（1年未満も可能）\n・更新: なし（期間満了で確定的に終了）\n・要件: 書面による契約 + 事前説明書面の交付\n・通知: 1年以上の契約は期間満了の1年〜6ヶ月前に終了通知\n・再契約: 双方合意があれば新たに契約可能\n\nFP1級: 定期借家の成立要件（書面+事前説明）の理解が重要。",
            },
        ],
        "FP-F. 相続・事業承継": [
            {
                "front": "相続税の基礎控除額の計算式を示せ。",
                "back": "基礎控除額 = 3,000万円 + 600万円 × 法定相続人の数\n例: 配偶者と子2人 = 3,000万円 + 600万円 × 3人 = 4,800万円\n課税遺産総額がこの額以下なら相続税は非課税。",
            },
        ],
    },
    "RISS": {
        "RISS-A. 暗号技術・認証技術": [
            {
                "front": "ディジタル署名の仕組みと検証プロセスを説明せよ。",
                "back": "署名プロセス:\n1. 送信者がメッセージのハッシュ値を計算（SHA-256等）\n2. ハッシュ値を送信者の秘密鍵で暗号化 → ディジタル署名\n3. メッセージ + ディジタル署名を送信\n\n検証プロセス:\n1. 受信者がメッセージのハッシュ値を計算\n2. ディジタル署名を送信者の公開鍵で復号\n3. 両ハッシュ値を比較 → 一致すれば改ざんなし\n\n保証する3要素:\n・認証（Authentication）: 送信者の本人確認\n・完全性（Integrity）: 改ざんの検出\n・否認防止（Non-repudiation）: 送信者が送信を否定できない\n\n注: 機密性は保証しない（暗号化が必要）。",
            },
            {
                "front": "共通鍵暗号と公開鍵暗号の特徴を比較せよ。",
                "back": "共通鍵暗号（AES等）: 同一鍵で暗号化/復号。高速。鍵配送問題あり。n人通信にn(n-1)/2個の鍵。\n公開鍵暗号（RSA等）: 異なる鍵。低速。鍵配送問題なし。n人通信に2n個の鍵。\nハイブリッド暗号: 公開鍵で共通鍵を配送し共通鍵でデータ暗号化（TLS等）。",
            },
        ],
        "RISS-B. セキュリティプロトコル": [
            {
                "front": "TLS 1.3のハンドシェイク手順とTLS 1.2からの主な改善点を説明せよ。",
                "back": "TLS 1.3ハンドシェイク（1-RTT）:\n1. ClientHello: 対応暗号スイート + 鍵共有パラメータ送信\n2. ServerHello: 暗号スイート選択 + 鍵共有パラメータ + 証明書 + Finished\n3. Client: Finished送信 → 暗号化通信開始\n\nTLS 1.2からの改善点:\n・RTT削減: 2-RTT → 1-RTT（0-RTTも可能だがリプレイ攻撃リスク）\n・脆弱な暗号の廃止: RC4, DES, 3DES, MD5, SHA-1, RSA鍵交換を廃止\n・前方秘匿性（PFS）の必須化: ECDHE/DHEのみ（RSA鍵交換を廃止）\n・ハンドシェイクの暗号化: ServerHello以降が暗号化される",
            },
            {
                "front": "OAuth 2.0とOpenID Connect（OIDC）の関係と認可コードフローを説明せよ。",
                "back": "関係:\n・OAuth 2.0: 認可（Authorization）フレームワーク。リソースへのアクセス権限委譲\n・OIDC: OAuth 2.0の上位レイヤー。認証（Authentication）を追加。IDトークン（JWT）を発行\n\n認可コードフロー:\n1. ユーザーが認可サーバーにリダイレクト\n2. ユーザーがログイン・同意\n3. 認可コードをクライアントに返却\n4. クライアントが認可コードをアクセストークンに交換（バックチャネル）\n5. アクセストークンでリソースサーバーにアクセス\n\nセキュリティ強化: PKCE（Proof Key for Code Exchange）でコード横取り攻撃を防止。SPAやモバイルアプリでは必須。",
            },
        ],
        "RISS-C. 攻撃手法と対策": [
            {
                "front": "SQLインジェクションの原理と対策を説明せよ。",
                "back": "原理: ユーザー入力をSQL文に直接埋め込み意図しないSQLが実行される。\n対策:\n1. プリペアドステートメント（パラメータ化クエリ）\n2. 入力値のエスケープ処理\n3. WAFの導入\n4. 最小権限の原則（DB接続ユーザー）",
            },
        ],
        "RISS-D. セキュリティマネジメント(ISMS)": [
            {
                "front": "ISO 27001のPDCAサイクルをISMS構築に適用する方法を説明せよ。",
                "back": "Plan: ISMSの確立（適用範囲定義、リスクアセスメント、管理策選択）\nDo: ISMSの導入・運用（管理策の実施、教育・訓練）\nCheck: ISMSの監視・レビュー（内部監査、マネジメントレビュー）\nAct: ISMSの維持・改善（是正処置、予防処置）\nAnnex Aに93の管理策（2022年版）。",
            },
        ],
        "RISS-E. インシデント対応・フォレンジック": [
            {
                "front": "CSIRTの主な機能と役割を説明せよ。",
                "back": "CSIRT（Computer Security Incident Response Team）:\n1. インシデントの検知・受付\n2. トリアージ（優先度判定）\n3. インシデント対応・封じ込め\n4. 原因分析・フォレンジック\n5. 復旧支援\n6. 再発防止策の策定\n7. 外部組織（JPCERT/CC等）との情報共有",
            },
        ],
        "RISS-F. ネットワーク・クラウドセキュリティ": [
            {
                "front": "ファイアウォールの種類（パケットフィルタリング、ステートフルインスペクション、WAF）を比較せよ。",
                "back": "1. パケットフィルタリング型:\n・OSI L3-L4で動作。IPアドレス・ポート番号で制御\n・高速だがアプリケーション層の攻撃は検知不可\n\n2. ステートフルインスペクション型:\n・通信のセッション状態を管理し、不正なパケットを遮断\n・SYN Flood等の異常な状態遷移を検知可能\n\n3. WAF（Web Application Firewall）:\n・OSI L7で動作。HTTPリクエストの内容を検査\n・SQLインジェクション・XSS等のWebアプリ攻撃を防御\n・シグネチャベース + 異常検知ベース\n\n4. 次世代ファイアウォール（NGFW）:\n・アプリケーション識別 + IPS + URLフィルタリングを統合",
            },
            {
                "front": "クラウドセキュリティにおける責任共有モデル（Shared Responsibility Model）をIaaS/PaaS/SaaSで比較せよ。",
                "back": "クラウド事業者の責任（下層から）:\n・物理インフラ（データセンター、ネットワーク）: 全モデルで事業者\n\nIaaS（例: AWS EC2）:\n・事業者: 物理HW、ハイパーバイザー\n・利用者: OS、ミドルウェア、アプリ、データ、アクセス管理\n\nPaaS（例: Azure App Service）:\n・事業者: 物理HW〜ランタイム環境\n・利用者: アプリ、データ、アクセス管理\n\nSaaS（例: Microsoft 365）:\n・事業者: 物理HW〜アプリケーション\n・利用者: データ、アクセス管理、ユーザー設定\n\n共通の利用者責任: データの暗号化、IAM設定、コンプライアンス対応。",
            },
        ],
        "RISS-G. セキュア開発・脆弱性管理": [
            {
                "front": "セキュアソフトウェア開発ライフサイクル（SSDLC）の各フェーズでのセキュリティ活動を説明せよ。",
                "back": "1. 要件定義: セキュリティ要件の明確化、脅威モデリング（STRIDE等）\n2. 設計: セキュリティアーキテクチャ設計、攻撃面（Attack Surface）の最小化\n3. 実装: セキュアコーディング（OWASP Top 10対策）、コードレビュー\n4. テスト: SAST（静的解析）、DAST（動的解析）、ファジング、ペネトレーションテスト\n5. リリース: セキュリティレビュー、脆弱性スキャン最終確認\n6. 運用・保守: パッチ管理、脆弱性監視、インシデント対応\n\nDevSecOps: CI/CDパイプラインにSAST/DAST/SCA（ソフトウェア構成分析）を自動化して組み込む。",
            },
        ],
    },
}


async def seed_courses_and_topics(db: AsyncSession) -> dict[str, uuid.UUID]:
    """コースとトピックをシード"""
    course_ids: dict[str, uuid.UUID] = {}
    topic_map: dict[str, uuid.UUID] = {}  # "CIA::A. 内部監査の目的と権限" -> UUID

    for syllabus_file in sorted(SYLLABUS_DIR.glob("*.json")):
        with open(syllabus_file) as f:
            data = json.load(f)

        # コース作成
        existing = await db.execute(
            select(Course).where(Course.code == data["code"])
        )
        course = existing.scalar_one_or_none()
        if course is None:
            course = Course(
                code=data["code"],
                name=data["name"],
                color=data["color"],
                exam_config=data.get("exam_config"),
            )
            db.add(course)
            await db.flush()

        course_ids[data["code"]] = course.id

        # トピック作成
        sort_order = 0
        for part in data["topics"]:
            parent_topic = Topic(
                course_id=course.id,
                name=part["name"],
                weight_pct=part.get("weight_pct", 0),
                level=part.get("level", 0),
                sort_order=sort_order,
            )
            db.add(parent_topic)
            await db.flush()
            sort_order += 1

            for child in part.get("children", []):
                child_topic = Topic(
                    course_id=course.id,
                    parent_id=parent_topic.id,
                    name=child["name"],
                    weight_pct=child.get("weight_pct", 0),
                    level=child.get("level", 1),
                    sort_order=sort_order,
                )
                db.add(child_topic)
                await db.flush()
                topic_map[f"{data['code']}::{child['name']}"] = child_topic.id
                sort_order += 1

    return course_ids, topic_map


async def seed_demo_user(db: AsyncSession, course_ids: dict[str, uuid.UUID]) -> None:
    """デモユーザー作成"""
    existing = await db.execute(select(User).where(User.id == DEMO_USER_ID))
    if existing.scalar_one_or_none() is not None:
        return

    user = User(
        id=DEMO_USER_ID,
        email="demo@sankanou.dev",
        hashed_password="$2b$12$jFvsXsKy3pqzqp/FVPpx5.uiglUbbtruuBzbcm87h2mLWvSRKKqDG",
        display_name="Demo User",
        role="learner",
    )
    db.add(user)
    await db.flush()

    # 全コースに登録
    for course_id in course_ids.values():
        enrollment = UserEnrollment(
            user_id=DEMO_USER_ID,
            course_id=course_id,
            desired_retention=0.9,
        )
        db.add(enrollment)


async def seed_sample_cards(
    db: AsyncSession,
    course_ids: dict[str, uuid.UUID],
    topic_map: dict[str, uuid.UUID],
) -> None:
    """サンプルカード投入"""
    now = datetime.now(timezone.utc)

    for course_code, topics in SAMPLE_CARDS.items():
        course_id = course_ids.get(course_code)
        if not course_id:
            continue

        for topic_name, cards in topics.items():
            topic_key = f"{course_code}::{topic_name}"
            topic_id = topic_map.get(topic_key)
            if not topic_id:
                continue

            for card_data in cards:
                card = Card(
                    course_id=course_id,
                    topic_id=topic_id,
                    front=card_data["front"],
                    back=card_data["back"],
                    difficulty_tier=1,
                )
                db.add(card)
                await db.flush()

                # CardReview作成 (New状態、即座にdue)
                card_review = CardReview(
                    user_id=DEMO_USER_ID,
                    card_id=card.id,
                    difficulty=0,
                    stability=0,
                    retrievability=1.0,
                    state=0,
                    due=now,
                    reps=0,
                    lapses=0,
                )
                db.add(card_review)


async def main() -> None:
    """メインシード処理"""
    # テーブルはAlembicマイグレーションで管理
    # 実行前に `alembic upgrade head` を実行すること

    async with async_session_factory() as db:
        try:
            course_ids, topic_map = await seed_courses_and_topics(db)
            await seed_demo_user(db, course_ids)
            await seed_sample_cards(db, course_ids, topic_map)
            await db.commit()
            print(f"Seed complete: {len(course_ids)} courses, {len(topic_map)} topics")
        except Exception as e:
            await db.rollback()
            print(f"Seed failed: {e}")
            raise


if __name__ == "__main__":
    asyncio.run(main())
